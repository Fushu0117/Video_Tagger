<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Perfil</title>
    <link rel="stylesheet" href="./css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp"
      crossorigin="anonymous"
    />
    <script
      src="https://kit.fontawesome.com/533f790df8.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div class="text-center pt-5">
      <div class="d-flex justify-content-center">
        <img
          id="image"
          class="rounded-5 img-thumbnail"
          alt="Imagen no encontrada"
        />
        <h1 id="name"></h1>
        <a class="m-lg-3" onclick="logout()" style="cursor: pointer"
          >Cerrar Sesi√≥n</a
        >
      </div>
      <button class="btn btn-outline-primary" id="videos">
        Obtener videos de Drive
      </button>
      <button class="btn btn-outline-success" id="video-db">Tus Videos</button>
      <div id="app" class="mx-auto w-75 p-3"></div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-qKXV1j0HvMUeCBQ+QVp7JcfGl760yU08IQ+GpUo5hlbpg51QRiuqHAJz8+BrxE/N"
      crossorigin="anonymous"
    ></script>
  </body>
  <script>
    const url = window.location.href;
    let urlWithoutHtml = url.substring(0, url.lastIndexOf("/"));

    var params = {};
    var regex = /([^&=]+)=([^&]*)/g,
      m;
    while ((m = regex.exec(location.href))) {
      params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
    }
    if (Object.keys(params).length > 0) {
      localStorage.setItem("authInfo", JSON.stringify(params));
    }
    // window.history.pushState(
    //   {},
    //   document.title,
    //   urlWithoutHtml + "/index.html"
    // );

    urlWithoutHtml = urlWithoutHtml.substring(
      0,
      urlWithoutHtml.lastIndexOf("#")
    );
    urlWithoutHtml = urlWithoutHtml.substring(
      0,
      urlWithoutHtml.lastIndexOf("/")
    );

    window.location.hash = "";

    let info = JSON.parse(localStorage.getItem("authInfo"));
    let email = "";

    fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
      headers: {
        Authorization: `Bearer ${info["access_token"]}`,
      },
    })
      .then((data) => data.json())
      .then((info) => {
        console.log("info: ", info);
        email = info.email;
        fetch(
          "https://stunning-capybara-1efe1a.netlify.app/.netlify/functions/api/users",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: info.name,
              email: info.email,
              image_url: info.picture,
            }),
          }
        );
        document.getElementById("name").innerHTML += info.name;
        document.getElementById("image").setAttribute("src", info.picture);
      });

    function logout() {
      fetch(
        "https://oauth2.googleapis.com/revoke?token=" + info["access_token"],
        {
          method: "POST",
          headers: {
            "Content-type": "application/x-www-form-urlencoded",
          },
        }
      ).then((data) => {
        location.href = `${urlWithoutHtml}/index.html`;
      });
    }

    let videos = document.querySelector("#videos");
    let videoDb = document.querySelector("#video-db");
    let result = document.querySelector("#result");
    let app = document.querySelector("#app");
    let ACCESS_TOKEN = info["access_token"];
    function searchFiles(q = "") {
      app.innerHTML = "";
      fetch(
        `https://www.googleapis.com/drive/v3/files?q=${q}&pageSize=50&supportsAllDrives=true&fields=files(name,id,mimeType)`,
        {
          method: "GET",
          headers: new Headers({ Authorization: "Bearer " + ACCESS_TOKEN }),
        }
      )
        .then((res) => {
          return res.json();
        })
        .then(function (val) {
          videos.removeAttribute("disabled", "");
          app.innerHTML = `<table class="table table-hover">
        <thead>
          <tr>
            <th scope="col"></th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody id="result"></tbody>
      </table>
      `;
          let result = document.querySelector("#result");
          val.files.forEach((file) => {
            let id = file.id;
            result.innerHTML += `
            <tr>
                <th scope="row">${file.name}</th>
                <td><a target="_blank" href="https://drive.google.com/file/d/${file.id}">${file.name}</a>
                </td>
                <td>
                <button class="btn btn-primary" onclick="setVideo('${urlWithoutHtml}', '${id}', '${file.name}')">Ver</button>
                </td>
            </tr>
            `;
          });
        });
    }

    function getVideos() {
      searchFiles("mimeType contains 'video/'");
      videos.setAttribute("disabled", "");
      app.innerHTML = `<div class="d-flex justify-content-center">
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>`;
    }

    function setVideo(url, id, fileName) {
      localStorage.setItem(
        "videoInfo",
        JSON.stringify({ name: fileName, email: email })
      );
      location.href = `${url}/player.html?id=${id}`;
    }

    function getVideosDB() {
      fetch(
        `https://stunning-capybara-1efe1a.netlify.app/.netlify/functions/api/videos/${email}`
      )
        .then((res) => {
          return res.json();
        })
        .then((val) => {
          console.log("val: ", val);
          app.innerHTML = `<table class="table table-hover">
            <thead>
              <tr>
                <th scope="col"></th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody id="result"></tbody>
          </table>
          `;
          let result = document.querySelector("#result");
          val.data.forEach((file) => {
            console.log("file: ", file);
            result.innerHTML += `
            <tr>
                <th scope="row">${file.title}</th>
                <td><a target="_blank" href="https://drive.google.com/file/d/${file.url}">${file.title}</a>
                </td>
                <td>
                <button class="btn btn-primary" onclick="setVideo('${urlWithoutHtml}', '${file.url}', '${file.title}')">Ver</button>
                </td>
            </tr>
            `;
          });
        });
    }
    videos.onclick = getVideos;
    videoDb.onclick = getVideosDB;
  </script>
</html>
